name: Orchestrator - Comment Events

on:
  issue_comment:
    types: [created, edited]

permissions:
  issues: write
  contents: read

jobs:
  check-answers:
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.issue.labels.*.name, 'draft') &&
      !contains(github.event.issue.labels.*.name, 'status:draft')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Check if answers provided
        id: check-answers
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
        run: |
          # Check if comment contains answer patterns
          if echo "$COMMENT_BODY" | grep -E "^(A[0-9]+:|Answer [0-9]+:|Q[0-9]+:.*A:|[0-9]+\.|Decision:)" > /dev/null; then
            echo "has_answers=true" >> $GITHUB_OUTPUT

            # Re-check issue readiness
            bash scripts/orchestration/check-issue-readiness.sh
          else
            echo "has_answers=false" >> $GITHUB_OUTPUT
          fi

      - name: Update issue status
        if: steps.check-answers.outputs.has_answers == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('/tmp/issue-readiness.json')) {
              const readiness = JSON.parse(fs.readFileSync('/tmp/issue-readiness.json', 'utf8'));

              if (readiness.ready) {
                // Remove waiting:answers label
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: 'waiting:answers'
                  });
                } catch (error) {
                  // Label might not exist, ignore
                }

                // Add ready:work label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['ready:work']
                });

                // Post resume comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `âœ… **Questions Answered - Resuming Work**\n\n` +
                        `All clarifying questions have been answered. Spawning development agent...`
                });

                // Trigger spawn agent
                const exec = require('child_process').exec;
                exec('bash scripts/orchestration/spawn-agent-comment.sh ${{ github.event.issue.number }}');
              }
            }
