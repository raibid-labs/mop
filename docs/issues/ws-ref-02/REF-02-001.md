# REF-02-001: gRPC Service - Project Setup and Protobuf Definitions

## Context
Initialize the gRPC authentication service project with protobuf definitions, Go module, and build infrastructure. This establishes the foundation for demonstrating OBI automatic gRPC instrumentation.

## Requirements
- [ ] Initialize Go module for gRPC service
- [ ] Define protobuf schema for AuthService
- [ ] Configure protoc with Go plugins (protoc-gen-go, protoc-gen-go-grpc)
- [ ] Create directory structure (cmd/server, cmd/client, internal, proto)
- [ ] Set up Buf for protobuf management (optional but recommended)
- [ ] Create multi-stage Dockerfile
- [ ] Add Makefile with proto generation, build, test targets
- [ ] Configure golangci-lint
- [ ] Generate Go code from proto files

## Acceptance Criteria
1. Go module initialized with gRPC dependencies
2. Protobuf schema defines all AuthService RPCs
3. `make proto` generates Go code successfully
4. Directory structure follows gRPC best practices
5. Dockerfile builds < 20MB image
6. `make build` compiles server and client
7. `make test` passes (even with no tests yet)
8. `make lint` runs without errors
9. README documents protobuf schema and setup

## Clarifying Questions

**Q1: Should we use Buf or plain protoc?**
- Context: Buf provides better tooling and linting
- Options:
  - A) Plain protoc (simple, standard)
  - B) Buf (better DX, linting, breaking change detection)
  - C) Both (Buf for dev, protoc fallback)
- Default: Buf for better protobuf management

**Q2: What gRPC version should we use?**
- Context: Compatibility and features
- Options:
  - A) v1.55.x (stable)
  - B) v1.60.x (latest stable)
  - C) Latest (bleeding edge)
- Default: v1.60.x for modern features

**Q3: Should we implement both unary and streaming RPCs?**
- Context: OBI should instrument all RPC types
- Options:
  - A) Unary only (simple)
  - B) Unary + server streaming (realistic)
  - C) All types (unary, server, client, bidirectional)
- Default: Unary + server streaming (covers common patterns)

**Q4: Should protobuf schema include validation?**
- Context: Input validation at proto level
- Options:
  - A) No validation (handle in code)
  - B) Use protoc-gen-validate
  - C) Document constraints only
- Default: Use protoc-gen-validate for better DX

## Technical Notes

### Files to Create
```
examples/02-grpc-service/
├── proto/
│   ├── auth/
│   │   └── v1/
│   │       ├── auth.proto          # AuthService definition
│   │       └── models.proto        # Shared messages
│   ├── buf.yaml                    # Buf configuration
│   └── buf.gen.yaml                # Buf code generation config
├── cmd/
│   ├── server/
│   │   └── main.go                 # gRPC server entrypoint
│   └── client/
│       └── main.go                 # Test client
├── internal/
│   └── service/                    # Service implementation (placeholder)
├── Dockerfile
├── Makefile
├── .golangci.yml
├── README.md
└── go.mod
```

### Protobuf Schema (proto/auth/v1/auth.proto)
```protobuf
syntax = "proto3";

package auth.v1;

option go_package = "github.com/your-org/mop/examples/02-grpc-service/gen/go/auth/v1;authv1";

import "google/protobuf/timestamp.proto";
import "validate/validate.proto";

service AuthService {
  // Unary RPC: User login
  rpc Login(LoginRequest) returns (LoginResponse);

  // Unary RPC: User logout
  rpc Logout(LogoutRequest) returns (LogoutResponse);

  // Unary RPC: Validate token
  rpc ValidateToken(ValidateRequest) returns (ValidateResponse);

  // Unary RPC: Refresh token
  rpc RefreshToken(RefreshRequest) returns (RefreshResponse);

  // Server streaming RPC: Subscribe to auth events
  rpc StreamEvents(EventsRequest) returns (stream Event);
}

message LoginRequest {
  string username = 1 [(validate.rules).string = {min_len: 3, max_len: 50}];
  string password = 2 [(validate.rules).string.min_len = 8];
}

message LoginResponse {
  string token = 1;
  string refresh_token = 2;
  google.protobuf.Timestamp expires_at = 3;
  User user = 4;
}

message LogoutRequest {
  string token = 1 [(validate.rules).string.min_len = 1];
}

message LogoutResponse {
  bool success = 1;
}

message ValidateRequest {
  string token = 1 [(validate.rules).string.min_len = 1];
}

message ValidateResponse {
  bool valid = 1;
  User user = 2;
  google.protobuf.Timestamp expires_at = 3;
}

message RefreshRequest {
  string refresh_token = 1 [(validate.rules).string.min_len = 1];
}

message RefreshResponse {
  string token = 1;
  google.protobuf.Timestamp expires_at = 2;
}

message EventsRequest {
  repeated string event_types = 1;
}

message Event {
  string event_type = 1;
  string user_id = 2;
  google.protobuf.Timestamp timestamp = 3;
  map<string, string> metadata = 4;
}

message User {
  string id = 1;
  string username = 2;
  string email = 3;
  repeated string roles = 4;
}
```

### Buf Configuration (proto/buf.yaml)
```yaml
version: v1
breaking:
  use:
    - FILE
lint:
  use:
    - DEFAULT
```

### Buf Generation (proto/buf.gen.yaml)
```yaml
version: v1
plugins:
  - plugin: go
    out: gen/go
    opt:
      - paths=source_relative
  - plugin: go-grpc
    out: gen/go
    opt:
      - paths=source_relative
  - plugin: validate
    out: gen/go
    opt:
      - paths=source_relative
      - lang=go
```

### Dependencies
```go
require (
    google.golang.org/grpc v1.60.0
    google.golang.org/protobuf v1.32.0
    github.com/envoyproxy/protoc-gen-validate v1.0.4
    go.uber.org/zap v1.27.0
    github.com/stretchr/testify v1.9.0
)
```

### Makefile Targets
```makefile
.PHONY: proto build test lint clean

proto:
	buf generate

build: proto
	go build -o bin/server ./cmd/server
	go build -o bin/client ./cmd/client

test:
	go test ./... -v -cover

lint:
	golangci-lint run

docker-build:
	docker build -t grpc-auth-service:latest .

clean:
	rm -rf bin/ gen/
```

### Testing Approach
- Validate protobuf schema compiles
- Test Go code generation
- Verify imports and packages correct
- No functional tests yet (service not implemented)

### Integration Points
- None yet (foundation issue)
- Will integrate with REF-02-002 (service implementation)

## Definition of Done
- [ ] Go module initialized with gRPC dependencies
- [ ] Protobuf schema defines all RPCs with validation
- [ ] Buf configured for proto management
- [ ] `make proto` generates Go code without errors
- [ ] Generated code compiles successfully
- [ ] Directory structure created with placeholders
- [ ] Dockerfile builds successfully
- [ ] Makefile with all standard targets working
- [ ] golangci-lint configuration present
- [ ] README documents schema and setup process
- [ ] All generated code committed to git
- [ ] Code reviewed for gRPC best practices
- [ ] PR merged to main branch

## Related Issues
- Blocks: REF-02-002 (service implementation needs proto)
- Blocks: REF-02-003 (client needs proto)
- Related: REF-01-001 (similar setup patterns)

## Labels
`workstream:ws-ref-02`, `priority:critical`, `status:new`, `type:setup`, `protocol:grpc`
