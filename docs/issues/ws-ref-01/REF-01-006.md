# REF-01-006: HTTP REST API - Grafana Dashboard

## Context
Create a Grafana dashboard specifically for the HTTP REST API example, visualizing metrics automatically collected by OBI eBPF instrumentation. Dashboard should show request rates, latencies, error rates, and endpoint-specific metrics.

## Requirements
- [ ] Create JSON dashboard definition for Grafana
- [ ] Add panel for request rate (requests per second)
- [ ] Add panel for latency distribution (p50, p95, p99)
- [ ] Add panel for error rate by status code
- [ ] Add panel for top endpoints by request count
- [ ] Add panel for slow endpoint tracking (>1s latency)
- [ ] Add panel for rate limiting events (429 responses)
- [ ] Add panel for concurrent connections
- [ ] Add variables for filtering (time range, endpoint, status)
- [ ] Use OBI metrics as data source
- [ ] Add helpful annotations and descriptions

## Acceptance Criteria
1. Dashboard loads without errors in Grafana
2. All panels display data from OBI metrics
3. Request rate panel shows RPS over time
4. Latency panel shows p50, p95, p99 percentiles
5. Error rate panel breaks down by status code
6. Endpoint panel shows top N endpoints
7. Slow request panel highlights requests >1s
8. Rate limit panel shows 429 events
9. Variables allow filtering by time and endpoint
10. Dashboard has clear title, descriptions, and layout

## Clarifying Questions

**Q1: What Grafana version should we target?**
- Context: Different versions have different features
- Options:
  - A) Grafana 9.x (stable)
  - B) Grafana 10.x (latest)
  - C) Grafana 11.x (cutting edge)
- Default: Grafana 10.x for balance of features and stability

**Q2: What data source will OBI metrics use?**
- Context: OBI can export to multiple backends
- Options:
  - A) Prometheus
  - B) InfluxDB
  - C) Tempo (traces as metrics)
- Default: Prometheus (most common for metrics)

**Q3: Should we include alerting rules?**
- Context: Proactive monitoring vs dashboard only
- Options:
  - A) Dashboard only (visualization)
  - B) Include alert rules (error rate, latency)
  - C) Separate alert configuration file
- Default: Include basic alert annotations in dashboard

**Q4: How should we organize panels?**
- Context: Dashboard layout and information hierarchy
- Options:
  - A) Single row (simple)
  - B) Multiple rows by category (organized)
  - C) Tabs/sections (complex but clean)
- Default: Multiple rows - Overview, Performance, Errors, Details

## Technical Notes

### Files to Create
```
lib/grafana/dashboards/examples/
├── http-api-dashboard.json      # Main dashboard
└── README.md                    # Dashboard documentation
```

### Dashboard Structure
```json
{
  "dashboard": {
    "title": "HTTP REST API - Product Catalog",
    "tags": ["obi", "http", "example"],
    "timezone": "browser",
    "panels": [
      // Row 1: Overview
      {}, // Request Rate
      {}, // Error Rate
      {}, // Avg Latency

      // Row 2: Performance
      {}, // Latency Distribution
      {}, // Slow Requests
      {}, // Concurrent Connections

      // Row 3: Endpoints
      {}, // Top Endpoints
      {}, // Endpoint Latency Breakdown

      // Row 4: Errors
      {}, // Status Code Distribution
      {}, // Rate Limiting Events
      {}, // Error Details
    ],
    "templating": {
      "list": [
        {
          "name": "endpoint",
          "type": "query",
          "query": "label_values(http_requests_total, endpoint)"
        }
      ]
    }
  }
}
```

### Example Panels

**Request Rate Panel**
```json
{
  "title": "Request Rate (RPS)",
  "type": "graph",
  "targets": [
    {
      "expr": "rate(http_requests_total{service=\"http-api\"}[5m])",
      "legendFormat": "{{method}} {{endpoint}}"
    }
  ],
  "yaxes": [
    {
      "format": "reqps",
      "label": "Requests/sec"
    }
  ]
}
```

**Latency Distribution Panel**
```json
{
  "title": "Response Time Distribution",
  "type": "graph",
  "targets": [
    {
      "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket{service=\"http-api\"}[5m]))",
      "legendFormat": "p50"
    },
    {
      "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{service=\"http-api\"}[5m]))",
      "legendFormat": "p95"
    },
    {
      "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{service=\"http-api\"}[5m]))",
      "legendFormat": "p99"
    }
  ],
  "yaxes": [
    {
      "format": "s",
      "label": "Latency"
    }
  ]
}
```

**Error Rate Panel**
```json
{
  "title": "Error Rate by Status Code",
  "type": "graph",
  "targets": [
    {
      "expr": "sum by (status_code) (rate(http_requests_total{service=\"http-api\", status_code=~\"4..|5..\"}[5m]))",
      "legendFormat": "{{status_code}}"
    }
  ]
}
```

**Slow Requests Panel**
```json
{
  "title": "Slow Requests (>1s)",
  "type": "stat",
  "targets": [
    {
      "expr": "sum(rate(http_request_duration_seconds_bucket{service=\"http-api\", le=\"+Inf\"}[5m])) - sum(rate(http_request_duration_seconds_bucket{service=\"http-api\", le=\"1\"}[5m]))"
    }
  ],
  "options": {
    "colorMode": "background",
    "graphMode": "area"
  }
}
```

### OBI Metrics Expected

The dashboard expects these metrics from OBI:
- `http_requests_total{service, method, endpoint, status_code}` - Request counter
- `http_request_duration_seconds_bucket{service, method, endpoint, le}` - Latency histogram
- `http_requests_in_flight{service}` - Concurrent requests
- `http_request_size_bytes` - Request body size
- `http_response_size_bytes` - Response body size

### Dashboard Layout

**Row 1: Overview (4 panels)**
- Request Rate (RPS) - Time series graph
- Error Rate - Gauge with threshold
- Average Latency - Stat panel
- Success Rate - Gauge (200/201 responses)

**Row 2: Performance (3 panels)**
- Latency Distribution (p50, p95, p99) - Time series
- Slow Requests (>1s) - Bar gauge
- Concurrent Connections - Time series

**Row 3: Endpoints (2 panels)**
- Top 10 Endpoints by Request Count - Bar chart
- Endpoint Latency Breakdown - Heatmap

**Row 4: Errors (3 panels)**
- Status Code Distribution - Pie chart
- Rate Limiting Events (429) - Time series
- Error Details Table - Table panel

### Testing Approach
```bash
# Import dashboard to Grafana
curl -X POST http://admin:admin@localhost:3000/api/dashboards/db \
  -H "Content-Type: application/json" \
  -d @lib/grafana/dashboards/examples/http-api-dashboard.json

# Generate test traffic
go run tests/load-generator.go

# Verify panels populate with data
# Check each panel displays correctly
# Verify filtering works
```

### Dependencies
- OBI agent deployed and collecting metrics
- Prometheus configured as Grafana data source
- HTTP API deployed (REF-01-004)
- Load generator (REF-06-001) for test data

### Integration Points
- Consumes metrics from OBI agent
- Displays data from HTTP API (REF-01-002, REF-01-003)
- Used in documentation (REF-07-003)
- Referenced in troubleshooting guide (REF-07-004)

## Definition of Done
- [ ] Dashboard JSON file created and valid
- [ ] All panels defined with correct queries
- [ ] Dashboard imports successfully to Grafana
- [ ] All panels display data when API is running
- [ ] Latency percentiles calculated correctly
- [ ] Error rate panel highlights issues
- [ ] Slow request panel identifies performance problems
- [ ] Variables work for filtering
- [ ] Dashboard layout is clean and organized
- [ ] README documents dashboard usage
- [ ] Tested with real OBI metrics
- [ ] Screenshots captured for documentation
- [ ] Code reviewed for query correctness
- [ ] PR merged to main branch

## Related Issues
- Blocked by: REF-01-004 (needs deployed API)
- Related: REF-01-005 (test data flows to dashboard)
- Related: REF-06-001 (load generator creates traffic)
- Related: REF-07-002 (part of dashboard suite)
- Related: REF-07-004 (used in troubleshooting guide)

## Labels
`workstream:ws-ref-01`, `priority:medium`, `status:new`, `type:observability`, `protocol:http`
